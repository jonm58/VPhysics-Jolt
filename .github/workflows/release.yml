name: Build Release

on: [workflow_dispatch]

jobs:
  release_draft:
    name: "Create Draft"
    runs-on: ubuntu-latest
    container: debian:bullseye
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create_release
        uses: shogo82148/actions-create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.run_number }}
          release_name: Build ${{ github.run_number }}
          draft: true
          prerelease: false
          make_latest: false

  windows:
    needs: release_draft
    strategy:
      fail-fast: false
      matrix:
        name: [sdk2013-sp, sdk2013-mp, asw, gmod, gmod_64]
        include:
          - name: sdk2013-sp
            branch: sdk2013-sp
            arch: '32'
            vscodeArch: 'x86'
          - name: sdk2013-mp
            branch: sdk2013-mp
            arch: '32'
            vscodeArch: 'x86'
          - name: asw
            branch: asw
            arch: '32'
            vscodeArch: 'x86'
          - name: gmod
            branch: gmod
            arch: '32'
            vscodeArch: 'x86'
          - name: gmod_64
            branch: gmod
            arch: '64'
            vscodeArch: 'x64'

    runs-on: windows-2022
    permissions:
      contents: write
    steps:
    - name: Checkout Mini Source SDK
      uses: actions/checkout@v4
      with:
        repository: RaphaelIT7/mini-source-sdk
        ref: gmod-changes

    - name: Checkout VPhysics Jolt
      uses: actions/checkout@v4
      with:
        path: ${{ matrix.branch }}/src/vphysics_jolt
        submodules: recursive

    - name: Find Visual Studio
      run: |
        $installationPath = Get-VSSetupInstance `
          | Select-VSSetupInstance -Require Microsoft.VisualStudio.Workload.NativeDesktop -Latest `
          | Select-Object -ExpandProperty InstallationPath
        Write-Output "VSDEVCMD=${installationPath}\Common7\Tools\VsDevCmd.bat" `
          | Out-File -FilePath "${Env:GITHUB_ENV}" -Append

    - name: Build MSVC x86
      working-directory: ${{ matrix.branch }}/src
      run: |
        & "${Env:COMSPEC}" /s /c "`"${Env:VSDEVCMD}`" -arch=x86 -host_arch=x64 -no_logo && set" `
          | % { , ($_ -Split '=', 2) } `
          | % { [System.Environment]::SetEnvironmentVariable($_[0], $_[1]) }
        .\fix_registry.bat
        .\createjoltprojects.bat ${{ matrix.arch }}
        devenv jolt.sln /upgrade
        msbuild jolt.sln /nodeReuse:false /t:Rebuild /p:Configuration=Release /p:Platform=${{ matrix.vscodeArch }} /m /v:minimal

    - name: Create zip file
      shell: pwsh
      run: |
        Compress-Archive "${{ matrix.branch }}/game/bin" "vphysics_jolt_${{ matrix.branch }}_win${{ matrix.arch }}.zip"

    - name: Upload release files
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.release_draft.outputs.upload_url }}
        asset_path: vphysics_jolt_${{ matrix.branch }}_win${{ matrix.arch }}.zip
        asset_name: vphysics_jolt_${{ matrix.branch }}_win${{ matrix.arch }}
        asset_content_type: application/octet-stream

  linux:
    needs: release_draft
    strategy:
      fail-fast: false
      matrix:
        name: [sdk2013-sp, sdk2013-mp, gmod, gmod_64]
        include:
          - name: sdk2013-sp
            branch: sdk2013-sp
            arch: '32'
          - name: sdk2013-mp
            branch: sdk2013-mp
            arch: '32'
          - name: gmod
            branch: gmod
            arch: '32'
          - name: gmod_64
            branch: gmod
            arch: '64'

    runs-on: ubuntu-latest
    container: debian:bullseye
    permissions:
      contents: write
    steps:
    - name: Install Dependencies
      run: |
        dpkg --add-architecture i386
        apt update
        apt install -y build-essential git libstdc++6:i386 gcc-multilib g++-multilib zip

    - name: Checkout Mini Source SDK
      uses: actions/checkout@v4
      with:
        repository: RaphaelIT7/mini-source-sdk
        ref: gmod-changes

    - name: Checkout VPhysics Jolt
      uses: actions/checkout@v4
      with:
        path: ${{ matrix.branch }}/src/vphysics_jolt
        submodules: recursive

    - name: Build GCC x86
      working-directory: ${{ matrix.branch }}/src
      run: |
        chmod +x createjoltprojects.sh
        chmod +x devtools/bin/vpc_linux
        chmod +x devtools/bin/vpc
        chmod +x devtools/gendbg.sh
        ./createjoltprojects.sh ${{ matrix.arch }}
        if [ "${{ matrix.arch }}" = "64" ]; then
          make -f jolt.mak ARCH_FLAGS="-march=x86-64 -mtune=generic" -j $(nproc)
        else
          make -f jolt.mak -j $(nproc)
        fi

    - name: Create zip file
      run: |
        cd ${{ matrix.branch }}/game
        zip -r vphysics_jolt_${{ matrix.branch }}_linux${{ matrix.arch }}.zip bin
        mv vphysics_jolt_${{ matrix.branch }}_linux${{ matrix.arch }}.zip ../../

    - name: Upload release files
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.release_draft.outputs.upload_url }}
        asset_path: vphysics_jolt_${{ matrix.branch }}_linux${{ matrix.arch }}.zip
        asset_name: vphysics_jolt_${{ matrix.branch }}_linux${{ matrix.arch }}
        asset_content_type: application/octet-stream

  linux-gmod-dedicated:
    needs: release_draft
    runs-on: ubuntu-latest
    container: debian:bullseye
    name: "GMod Dedicated Server"
    strategy:
      fail-fast: false
      matrix:
        arch: [32, 64]
    permissions:
      contents: write
    steps:
    - name: Install Dependencies
      run: |
        dpkg --add-architecture i386
        apt update
        apt install -y build-essential git libstdc++6:i386 gcc-multilib g++-multilib zip

    - name: Checkout Mini Source SDK
      uses: actions/checkout@v4
      with:
        repository: RaphaelIT7/mini-source-sdk
        ref: gmod-changes

    - name: Checkout VPhysics Jolt
      uses: actions/checkout@v4
      with:
        path: gmod/src/vphysics_jolt
        submodules: recursive

    - name: Build GCC x86
      working-directory: gmod/src
      run: |
        chmod +x createjoltprojects_server.sh
        chmod +x devtools/bin/vpc_linux
        chmod +x devtools/bin/vpc
        chmod +x devtools/gendbg.sh
        ./createjoltprojects_server.sh ${{ matrix.arch }}
        if [ "${{ matrix.arch }}" = "64" ]; then
          make -f jolt.mak ARCH_FLAGS="-march=x86-64 -mtune=generic" -j $(nproc)
        else
          make -f jolt.mak -j $(nproc)
        fi

    - name: Create zip file
      run: |
        cd gmod/game
        zip -r vphysics_jolt_gmod_dedicated_linux${{ matrix.arch }}.zip bin
        mv vphysics_jolt_gmod_dedicated_linux${{ matrix.arch }}.zip ../../

    - name: Upload release files
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.release_draft.outputs.upload_url }}
        asset_path: vphysics_jolt_gmod_dedicated_linux${{ matrix.arch }}.zip
        asset_name: vphysics_jolt_gmod_dedicated_linux${{ matrix.arch }}
        asset_content_type: application/octet-stream